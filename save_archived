#!/bin/bash

check_for_subdirs() {
    local dir="$1"
    shopt -s nullglob # Enable nullglob to make globs expand to nothing if no matches
    for d in "$dir"/*/ ; do
        if [[ -d "$d" ]]; then
            shopt -u nullglob # Disable nullglob
            return 0 # Found at least one subdirectory
        fi
    done
    shopt -u nullglob # Disable nullglob
    return 1 # No subdirectories found
}

DOMAIN="$1"
SUBDIR="archived_$DOMAIN"

type -P yawbdl  &>/dev/null && ISINST=1 || ISINST=0
if [ $ISINST -eq 0 ]
then
    echo "Install https://github.com/BGforgeNet/yawbdl"
    exit 127
fi

PERLDATETIME=$(perl -e 'my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime(time - 30*86400); $year += 1900; $mon += 1; printf ("%04d%02d%02d%02d%02d%02d", $year, $mon, $mday, $hour, $min, $sec)')

if check_for_subdirs $SUBDIR; then
	echo "Checking for empty files..."
	EFL=$SUBDIR"/empty_files_"$PERLDATETIME".log"
	touch "$EFL"
	find $SUBDIR/*/ -type f -empty -exec sh -c 'if rm "{}"; then echo "Removed {}"; fi' \; | tee -a $EFL
	if [ ! -s "$EFL" ]; then
		rm "$EFL"
		echo "OK"
	fi
fi

if yawbdl -d $DOMAIN -o $SUBDIR --no-fail --retries 10 --delay 2; then
    mv "$SUBDIR/snapshots.json" "$SUBDIR/snapshots_downloaded_$PERLDATETIME.json"
	mv "$SUBDIR/yawbdl.log" "$SUBDIR/snapshots_downloaded_$PERLDATETIME.log"
fi

exit

if [[ "$SAVESITE_MAXSNAPSHOTPAGES" == "" ]]
then
    # increase it if need to backup huge sites, or better execute 'export SAVESITE_MAXSNAPSHOTPAGES=...' before running the script
    MAXSP=100000
else
    MAXSP="$SAVESITE_MAXSNAPSHOTPAGES"
fi

type -P wayback_machine_downloader &>/dev/null && ISINST=1 || ISINST=0

if [ $ISINST -eq 0 ]
then
    echo "Install Ruby, then execute 'sudo gem install wayback_machine_downloader'"
    echo "See also https://linuxnightly.com/how-to-download-a-website-from-the-wayback-machine"
    echo ""
    exit 127
fi

SUBDIR="archived_$DOMAIN"
if [ -e "$SUBDIR" ]; then
    echo "$SUBDIR already exists (completely downloaded, but when?)"
elif [ -e "$SUBDIR.zip" ]; then
    echo "$SUBDIR already exists (completely downloaded and zipped)"
    exit
#elif [ -e "~$SUBDIR" ]; then
#    echo "~$SUBDIR already exist (incompletely downloaded), you should remove it"
#    exit 1
else
    mkdir -p ~$SUBDIR
    wayback_machine_downloader -s -p $MAXSP -c 1 -d ./~$SUBDIR http://$DOMAIN #| tee -a ./~$SUBDIR/wayback_machine_downloader.log
    if [ $? -eq 0 ]
    then
	if [ -d "~$SUBDIR" ]; then
	    du -h ./~$SUBDIR
	    mv "~$SUBDIR" "$SUBDIR"
	    echo "$SUBDIR downloaded successfully (perhaps)"
	else
	    exit
	fi
    else
	echo "~$SUBDIR not downloaded"
	exit 1
    fi
fi

ZIPFILE="$SUBDIR.zip"
if [ -d "$SUBDIR" ]; then
	if [ ! -e "$ZIPFILE" ]; then
		zip -9 -T -r $ZIPFILE $SUBDIR
		if [ $? -eq 0 ]; then
			if [ ! -e "~$SUBDIR" ]; then
				echo -n "Deleting ~$SUBDIR..."
				mv "$SUBDIR" "~$SUBDIR"
				rm -r "~$SUBDIR"
				if [ $? -eq 0 ]; then
				    echo " Done"
				else
				    echo ""
				    exit 1
				fi
			fi
		fi
	fi
fi
